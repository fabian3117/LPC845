/*******************************************************************************************************************************//**
 *
 * @file		display.cpp
 * @brief		Descripcion del modulo
 * @date		26 jul. 2022
 * @author		Ing. Marcelo Trujillo
 *
 **********************************************************************************************************************************/

/***********************************************************************************************************************************
 *** INCLUDES
 **********************************************************************************************************************************/
#include <display7Segmentos.h>

/***********************************************************************************************************************************
 *** DEFINES PRIVADOS AL MODULO
 **********************************************************************************************************************************/

/***********************************************************************************************************************************
 *** MACROS PRIVADAS AL MODULO
 **********************************************************************************************************************************/

/***********************************************************************************************************************************
 *** TIPOS DE DATOS PRIVADOS AL MODULO
 **********************************************************************************************************************************/

/***********************************************************************************************************************************
 *** TABLAS PRIVADAS AL MODULO
 **********************************************************************************************************************************/

/***********************************************************************************************************************************
 *** VARIABLES GLOBALES PUBLICAS
 **********************************************************************************************************************************/

/***********************************************************************************************************************************
 *** VARIABLES GLOBALES PRIVADAS AL MODULO
 **********************************************************************************************************************************/

/***********************************************************************************************************************************
 *** IMPLEMENTACION DE LOS METODODS DE LA CLASE
 **********************************************************************************************************************************/
display7Segmentos::display7Segmentos( vector <gruposdedigitos * > g ,segmentos * s , barrido * b , const uint8_t *PosicionRelativa):
			m_grupos ( g ) , m_seg ( s ) , m_dig ( b ) , m_PosicionRelativa(PosicionRelativa)
{

	m_ticks = 5;

	m_maxdigitos = 0 ;
	for ( uint8_t j = 0 ; j < m_grupos.size() ; j++)
	{
		m_maxdigitos += m_grupos[j]->m_cantidad ;
		for ( uint8_t i = 0 ; i < m_grupos[ j ]->m_cantidad ; i++)
			m_bufferdisplay.push_back( new digito( m_grupos[j]->m_codigo , m_grupos[j]->m_estado ) ) ;
	}
	m_inx = 0;
	g_swhandler.push_back( this );
}

display7Segmentos::~display7Segmentos() {
	// TODO Auto-generated destructor stub
}

void display7Segmentos::SWhandler ( )
{
	//m_seg->SetSegmentos(digito::APAGAR);

	m_ticks--;
	if ( !m_ticks )
	{
		m_ticks = 3;
		m_dig->SetDigito();
		m_seg->SetSegmentos(m_bufferdisplay[m_inx]->get());
		m_inx ++;
		m_inx %= m_maxdigitos;
	}
}

void display7Segmentos::Set( uint32_t valor , uint8_t dsp )
{
	uint16_t a;
	uint8_t aux[ m_maxdigitos ];

	for (uint8_t i = 0 ; i < m_grupos[ dsp ]->m_cantidad  ; i ++ , valor /= 10 )
		aux[ i ] = valor % 10 ;

	for (uint8_t i = 0 ; i < m_grupos[ dsp ]->m_cantidad  ; i ++ )
	{
		a = m_PosicionRelativa[ i + m_grupos[ dsp ]->m_comienzo ];
		m_bufferdisplay[ a ]->set( aux[ i ] );
	}
}
